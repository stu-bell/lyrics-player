(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function o(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=o(i);fetch(i.href,r)}})();const h=e=>{const t=document.getElementById(e);if(t===null)throw new Error(`Cannot find element ${e}.`);return t},_=(e,t=null)=>o=>o.hasOwnProperty(e)?o[e]:t;function F(e){var t=e.lastIndexOf(".");return t===-1?"":e.substring(t+1).toLowerCase()}const S=async e=>new Promise((t,o)=>{const n=new FileReader;n.onload=function(i){t(i.target.result)},n.onerror=i=>{var r;o("Error reading file:"+((r=i.target.error)==null?void 0:r.message))},n.readAsText(e)});function R(e){const o=e.replace(/\r\n/g,`
`).split(`
`),n=o[0].split("	").map(r=>r.trim());return o.slice(1).map(r=>{const l=r.split("	");if(l.join("")==="")return null;let c={};return n.forEach((g,a)=>{c[g]=l[a]||""}),c}).filter(r=>!!r)}function j(e,t){const o=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(o),i=document.createElement("a");i.href=n,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i)}const b=/\[\d?\d?:?\d?\d\.?\d?\d?\d?\]/g;function z(e){const t=e.replace(`\r
`,`
`).replace("\r",`
`).split(`
`).filter(n=>n.trim()!=="").filter(n=>!(n.startsWith("[")&&n.endsWith("]")));let o=[{timestamp:0,text:""}];return t.forEach(n=>{const i=n.trim(),r=i.match(b);if(r&&r.length>0){const l=i.replace(b,"").trim();r.forEach(c=>{o.push({timestamp:I(c),text:l})})}}),o.sort((n,i)=>(n.timestamp||0)-(i.timestamp||0)),o}function U(e){const o=e.split(`
`).map(n=>({text:n,timestamp:null}));return[{timestamp:0,text:""},...o]}function V(e,t){return(F(t.name)==="lrc"?z:U)(e)}function I(e){let t;const n=e.replace(/[[\]]/g,"").split(":");if(n.length===1)t=parseFloat(n[0]);else{const i=parseInt(n[0]),r=parseFloat(n[1]);t=i*60+r}return t}let u,s={lines:[],filesList:[],fileType:"txt",numberOfLines:5,currentLineIndex:0,currentFileIndex:0};function q(e,t=""){const o=document.createElement("li");o.textContent=t,o.classList.add("zero"),e.prepend(o),e.lastElementChild&&e.lastElementChild.remove();const n=e.firstElementChild;if(n){n.offsetWidth,n.classList.remove("zero"),n.classList.add("large");const i=e.getElementsByTagName("li")[1];i&&i.classList.remove("large")}}function G(e,t=""){e.querySelectorAll(".zero").forEach(i=>i.remove());const o=e.firstElementChild;if(o){o.classList.remove("large"),o.classList.add("zero");const i=e.getElementsByTagName("li")[1];i&&i.classList.add("large"),o.addEventListener("transitionend",r=>r.target.remove())}const n=document.createElement("li");n.textContent=t,e.appendChild(n)}let T=null,$;function w(e){if(T&&clearTimeout(T),s.lines[s.currentLineIndex+1]&&s.lines[s.currentLineIndex+1].hasOwnProperty("timestamp")&&s.lines[s.currentLineIndex+1].timestamp!==null&&s.lines[s.currentLineIndex+1].timestamp>=0){const t=e||s.lines[s.currentLineIndex].timestamp||0,n=(s.lines[s.currentLineIndex+1].timestamp||0)-t;n>=0&&(T=setTimeout(()=>{$=Date.now(),P()},n*1e3))}}const H=(e=500)=>Date.now()-$<e;function J(e,t){for(u=t,s.lines=e,s.currentLineIndex=0;u.firstChild;)u.firstChild.remove();const o=s.lines.slice(s.currentLineIndex,s.currentLineIndex+s.numberOfLines).map(_("text",""));for(let n of o){const i=document.createElement("li");i.textContent=n,u.appendChild(i)}w()}function P(){s.currentLineIndex++,s.currentLineIndex>=s.lines.length&&E(),w();const e=s.lines[s.currentLineIndex+s.numberOfLines-1],t=e?e.text:"";G(u,t)}let O;function K(){if(Date.now()-O<800){s.currentLineIndex--,w();const e=s.lines[s.currentLineIndex],t=e?e.text:"";q(u,t)}else w();O=Date.now()}let C,k;function M(){return k}function B(){return C||(C=new window.AudioContext),C}async function Y(e){const t=B(),o=await e.arrayBuffer();return new Promise((n,i)=>{t.decodeAudioData(o,n,i)})}function Q(e){const o=B().createBufferSource();return o.buffer=e,o}function X(e){const t=e.context,o=t.createGain();return e.connect(o),o.connect(t.destination),o}function Z(e){const t=Q(e);return{source:t,gain:X(t)}}function ee(e,t=0,o,n,i){const r=e.source.context;e.source.start(o,n,i),e.gain.gain.setValueAtTime(0,r.currentTime),e.gain.gain.linearRampToValueAtTime(1,r.currentTime+t),k=e}function te(e,t=0){const o=e.source.context,n=o.currentTime+t;e.gain.gain.setValueAtTime(1,o.currentTime),e.gain.gain.linearRampToValueAtTime(0,n),e.source.stop(n)}function ne(e,t,o=1,n,i){t?ee(t,o,void 0,n,i):console.log("crossFade called but graphNext is null"),e&&te(e,o)}let L,p,f,d,m;const y="_playlist.tsv";async function ie(e){m=await se(e),m.length&&(d=-1,f=A(m[0]))}function oe(){return f&&(d++,L=p,p=f),d+1<m.length?f=A(m[d+1]):f=null,p}function re(){return L&&(d--,f=p,p=L),d>0&&(L=A(m[d-1])),p}function A(e){return{lyrics:{file:e.lyricsFile,text:S(e.lyricsFile)},audio:{file:e.audioFile,buffer:e.audioFile?Y(e.audioFile):null,offset:e.audio_start?I(e.audio_start):0,end:e.audio_end?I(e.audio_end):void 0}}}async function se(e){const t=e.find(i=>i.name.toLowerCase()===y);t||(window.alert(`Oops! We couldn't find a ${y} file in that folder! Save one in that folder and edit it to make your playlist.`),ae(e),window.alert(`We've just downloaded a ${y} file for you, with the tracks we could find in the folder you chose. Open it in a spreadsheet and put the lyrics and audio files in the correct order. Then refresh the sing along app and retry.`),location.reload());const o=R(await S(t)),n=le(o,e);return n.length||window.alert(`Error: ${y} empty`),n}function le(e,t){let o=[],n=[];const i=a=>t.find(x=>x.name===a),r=a=>{if(a.lyrics){a.lyricsFile=i(a.lyrics);const x=F(a.lyrics);if(a.lyricsFile){if(!(x==="lrc"||x==="txt"))return n.push(`Only .lrc or .txt files supported, but found ${a.lyrics}`),null}else return n.push(`Playlist includes ${a.lyrics} but we couldn't find that in the folder.`),null}else return n.push(`Each playlist row must contain a lyrics file. ${a.audio?a.audio:""}`),null;return a.audio?(a.audioFile=i(a.audio),a.audioFile||n.push(`Playlist includes ${a.audio} but we couldn't find that in the folder.`)):o.push(a.lyrics),a},l=e.map(r).filter(a=>a!==null);l.length||window.alert(`Error: the ${y} file contained no valid rows, or we couldn't find any corresponding files.`);const c=n.join(`
`);c&&window.alert(`Error: ${c}`);const g=o.join(`
`);return g&&window.alert(`Warning: the following tracks don't have audio: ${g}`),l}function ae(e){const t=e.filter(l=>{const c=F(l.name);return c==="mp3"||c==="m4a"}).map(l=>l.name),o=e.filter(l=>{const c=F(l.name);return c==="lrc"||c==="txt"}).map(l=>l.name),n=t.length>o.length?t.length:o.length;let i=[];for(let l=0;l<n;l++)i.push(`${o[l]||""}	${t[l]||""}	`);const r=`lyrics	audio	audio_start	audio_end\r
`+i.join(`\r
`);j(r,"_playlist.tsv")}let N;async function ce(e,t){N=t;const n=e.target.files,i=Array.from(n);await ie(i),E()}let v=null;async function D(e){if(e){const t=await e.audio.buffer,o=t?Z(t):null,n=V(await e.lyrics.text,e.lyrics.file),i=1;ne(M(),o,i,e.audio.offset),J(n,N);const r=e.audio.end?e.audio.end:t==null?void 0:t.duration;r&&(v&&clearTimeout(v),v=setTimeout(E,(r-e.audio.offset-i)*1e3))}}async function E(){D(oe())}async function de(){D(re())}const W=h("lyricsContainer");h("fileInputButton").addEventListener("click",()=>h("fileInput").click());h("fileInput").addEventListener("change",e=>{ce(e,W),h("home").classList.add("hidden")});document.addEventListener("keydown",function(e){e.key==="S"&&W.classList.toggle("hidden")});document.addEventListener("keydown",function(e){(e.key===" "||e.key==="ArrowDown"||e.key==="PageDown"||e.key==="ArrowRight")&&!H(500)?P():e.key==="ArrowUp"||e.key==="PageUp"||e.key==="ArrowLeft"?K():e.key==="0"&&(console.log("reset"),w())});document.addEventListener("touchstart",function(){P()});document.addEventListener("keydown",function(e){e.key==="N"?E():e.key==="P"&&de()});(!window.FileReader||!window.FileList||!window.File||!window.Blob)&&alert("Your browser does not support the required APIs. Please use a modern browser.");
